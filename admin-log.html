<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† - Admin Log</title>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .log-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .password-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .password-box h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .password-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
        }

        .password-box button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .password-box button:hover {
            background: #45a049;
        }

        .password-error {
            color: #f44336;
            margin-top: 10px;
            display: none;
        }

        .log-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .log-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            font-size: 32px;
            color: #667eea;
        }

        .stat-card p {
            margin: 10px 0 0 0;
            color: #666;
        }

        .log-filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .log-filters select,
        .log-filters input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .log-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .log-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .log-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
        }

        .log-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .log-table tr:hover {
            background: #f5f5f5;
        }

        .action-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .action-create {
            background: #4CAF50;
            color: white;
        }

        .action-update {
            background: #2196F3;
            color: white;
        }

        .action-delete {
            background: #f44336;
            color: white;
        }

        .time-badge {
            color: #666;
            font-size: 13px;
        }

        .no-logs {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-size: 16px;
            font-weight: 600;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        @media (max-width: 768px) {
            .log-table {
                overflow-x: auto;
            }

            .log-filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="passwordOverlay" class="password-overlay">
        <div class="password-box">
            <h2>ğŸ”’ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø­Ù…ÙŠ</h2>
            <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„</p>
            <input type="password" id="logPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="verifyLogPassword()">Ø¯Ø®ÙˆÙ„</button>
            <p class="password-error" id="passwordError">âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
        </div>
    </div>

    <!-- Main Content (Hidden until password verified) -->
    <div id="mainContent" style="display: none;">
        <div class="log-container">
            <!-- Header -->
            <div class="log-header">
                <h1>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† - Admin Log</h1>
                <p>Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ Ù‚Ø§Ù… Ø¨Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</p>
            </div>

            <!-- Statistics -->
            <div class="log-stats">
                <div class="stat-card">
                    <h3 id="totalLogs">0</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
                </div>
                <div class="stat-card">
                    <h3 id="todayLogs">0</h3>
                    <p>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                </div>
                <div class="stat-card">
                    <h3 id="uniqueAdmins">0</h3>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="log-filters">
                <select id="filterAdmin" onchange="filterLogs()">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
                </select>
                <select id="filterAction" onchange="filterLogs()">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                    <option value="create">Ø¥Ø¶Ø§ÙØ©</option>
                    <option value="update">ØªØ¹Ø¯ÙŠÙ„</option>
                    <option value="delete">Ø­Ø°Ù</option>
                </select>
                <input type="date" id="filterDate" onchange="filterLogs()">
                <button onclick="clearFilters()" style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
            </div>

            <!-- Logs Table -->
            <div class="log-table">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="4" class="no-logs">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Refresh Button -->
        <button class="refresh-btn" onclick="loadLogs()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        let allLogs = [];
        let filteredLogs = [];
        let supabase = null;

        // Initialize Supabase
        async function initSupabase() {
            if (window.supabaseClient) {
                supabase = window.supabaseClient;
                return true;
            }
            
            // Fallback: create client directly
            if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                const { createClient } = window.supabase;
                supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                return true;
            }
            
            console.error('Failed to initialize Supabase');
            return false;
        }

        // Hash password using SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Verify log password
        async function verifyLogPassword() {
            const password = document.getElementById('logPassword').value;
            const errorEl = document.getElementById('passwordError');

            if (!password) {
                errorEl.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                errorEl.style.display = 'block';
                return;
            }

            try {
                // Initialize Supabase if not already
                if (!supabase) {
                    await initSupabase();
                }

                if (!supabase) {
                    errorEl.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                    errorEl.style.display = 'block';
                    return;
                }

                // Hash the entered password
                const hashedPassword = await hashPassword(password);

                // Check against database
                const { data, error } = await supabase
                    .from('admin_log_password')
                    .select('password_hash, is_active')
                    .eq('is_active', true)
                    .single();

                if (error || !data) {
                    errorEl.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                    errorEl.style.display = 'block';
                    return;
                }

                if (data.password_hash === hashedPassword) {
                    // Password correct
                    document.getElementById('passwordOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    loadLogs();
                } else {
                    errorEl.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error verifying password:', error);
                errorEl.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚';
                errorEl.style.display = 'block';
            }
        }

        // Allow Enter key to submit password
        document.getElementById('logPassword')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyLogPassword();
            }
        });

        // Load logs from database
        async function loadLogs() {
            try {
                // Initialize Supabase if not already
                if (!supabase) {
                    await initSupabase();
                }

                if (!supabase) {
                    document.getElementById('logsTableBody').innerHTML = `
                        <tr><td colspan="4" class="no-logs">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                    `;
                    return;
                }

                const { data, error } = await supabase
                    .from('admin_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500);

                if (error) throw error;

                allLogs = data || [];
                filteredLogs = allLogs;
                updateStatistics();
                updateAdminFilter();
                displayLogs();
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsTableBody').innerHTML = `
                    <tr><td colspan="4" class="no-logs">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</td></tr>
                `;
            }
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('totalLogs').textContent = allLogs.length;

            // Count today's logs
            const today = new Date().toDateString();
            const todayLogs = allLogs.filter(log => {
                const logDate = new Date(log.created_at).toDateString();
                return logDate === today;
            });
            document.getElementById('todayLogs').textContent = todayLogs.length;

            // Count unique admins
            const uniqueAdmins = [...new Set(allLogs.map(log => log.admin_username))];
            document.getElementById('uniqueAdmins').textContent = uniqueAdmins.length;
        }

        // Update admin filter dropdown
        function updateAdminFilter() {
            const adminFilter = document.getElementById('filterAdmin');
            const uniqueAdmins = [...new Set(allLogs.map(log => log.admin_username))];
            
            adminFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>';
            uniqueAdmins.forEach(admin => {
                adminFilter.innerHTML += `<option value="${admin}">${admin}</option>`;
            });
        }

        // Filter logs
        function filterLogs() {
            const adminFilter = document.getElementById('filterAdmin').value;
            const actionFilter = document.getElementById('filterAction').value;
            const dateFilter = document.getElementById('filterDate').value;

            filteredLogs = allLogs.filter(log => {
                let match = true;

                if (adminFilter && log.admin_username !== adminFilter) {
                    match = false;
                }

                if (actionFilter && log.action_type !== actionFilter) {
                    match = false;
                }

                if (dateFilter) {
                    const logDate = new Date(log.created_at).toISOString().split('T')[0];
                    if (logDate !== dateFilter) {
                        match = false;
                    }
                }

                return match;
            });

            displayLogs();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filterAdmin').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterDate').value = '';
            filteredLogs = allLogs;
            displayLogs();
        }

        // Display logs in table
        function displayLogs() {
            const tbody = document.getElementById('logsTableBody');

            if (filteredLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-logs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
                return;
            }

            tbody.innerHTML = filteredLogs.map(log => {
                const date = new Date(log.created_at);
                const timeStr = date.toLocaleString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const actionText = {
                    'create': 'Ø¥Ø¶Ø§ÙØ©',
                    'update': 'ØªØ¹Ø¯ÙŠÙ„',
                    'delete': 'Ø­Ø°Ù'
                }[log.action_type] || log.action_type;

                const actionClass = `action-${log.action_type}`;

                return `
                    <tr>
                        <td><span class="time-badge">${timeStr}</span></td>
                        <td><strong>${log.admin_username}</strong></td>
                        <td><span class="action-badge ${actionClass}">${actionText}</span></td>
                        <td>${log.record_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            await initSupabase();
            // Focus on password input
            document.getElementById('logPassword')?.focus();
        });
    </script>
</body>
</html>
